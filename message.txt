-- AutoFarm cho Coin_Serverr
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local StarterGui = game:GetService("StarterGui")
local LocalPlayer = Players.LocalPlayer

-- Notify helper
local function notify(title, text, dur)
    pcall(function()
        StarterGui:SetCore("SendNotification", {
            Title = title,
            Text = text,
            Duration = dur or 3
        })
    end)
end

-- Xóa GUI cũ
pcall(function()
    if game:GetService("CoreGui"):FindFirstChild("FarmGUI") then
        game:GetService("CoreGui").FarmGUI:Destroy()
    end
end)

-- GUI
local gui = Instance.new("ScreenGui", game:GetService("CoreGui"))
gui.Name = "FarmGUI"

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 180, 0, 100)
frame.Position = UDim2.new(0, 10, 0, 250)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)

local toggleBtn = Instance.new("TextButton", frame)
toggleBtn.Size = UDim2.new(1, -20, 0, 40)
toggleBtn.Position = UDim2.new(0, 10, 0, 10)
toggleBtn.BackgroundColor3 = Color3.fromRGB(80, 160, 80)
toggleBtn.Text = "Start Farm"

local status = Instance.new("TextLabel", frame)
status.Size = UDim2.new(1, -20, 0, 30)
status.Position = UDim2.new(0, 10, 0, 60)
status.BackgroundTransparency = 1
status.Text = "Status: OFF"

-- Farm logic
local farming = false

-- chỉ tìm Coin_Serverr
local function getCoins()
    local coins = {}
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("BasePart") and obj.Name == "Coin_Serverr" then
            table.insert(coins, obj)
        end
    end
    return coins
end

local function getNearestCoin()
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    local hrp = char.HumanoidRootPart

    local nearest, minDist = nil, math.huge
    for _, coin in pairs(getCoins()) do
        local dist = (hrp.Position - coin.Position).Magnitude
        if dist < minDist then
            nearest = coin
            minDist = dist
        end
    end
    return nearest
end

local function moveToCoin(coin)
    local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    notify("AutoFarm", "Bay tới: " .. tostring(coin.Name), 1)

    local dist = (hrp.Position - coin.Position).Magnitude
    local speed = 25
    local time = math.clamp(dist / speed, 0.4, 4)

    local tween = TweenService:Create(hrp, TweenInfo.new(time, Enum.EasingStyle.Linear), {
        CFrame = coin.CFrame + Vector3.new(0,3,0)
    })
    tween:Play()
    tween.Completed:Wait()
end

local function autoFarm()
    while farming do
        local coin = getNearestCoin()
        if coin then
            moveToCoin(coin)
        else
            notify("AutoFarm", "Không tìm thấy Coin_Serverr", 1)
            task.wait(1)
        end
    end
end

toggleBtn.MouseButton1Click:Connect(function()
    farming = not farming
    if farming then
        toggleBtn.Text = "Stop Farm"
        status.Text = "Status: ON"
        notify("AutoFarm", "Đã bật", 2)
        task.spawn(autoFarm)
    else
        toggleBtn.Text = "Start Farm"
        status.Text = "Status: OFF"
        notify("AutoFarm", "Đã tắt", 2)
    end
end)
