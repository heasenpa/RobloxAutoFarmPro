--[[ 
    Auto Farm Fix V2 - by ChatGPT
    - Farm mượt, không delay, giữ mục tiêu ổn định
    - NoClip xuyên tường
    - firetouchinterest nhặt chắc chắn
    - In tên item khi xuất hiện
    - HUD + Anti-AFK
    - Bật/Tắt bằng phím G
]]

--===== CẤU HÌNH =====--
local NameKeys = {"coin", "beachball"} -- sửa thành tên item bạn muốn farm
local ScanRange = 200                  -- Tầm quét
local FlySpeed = 80                    -- Tốc độ bay
local PickupDist = 5                   -- Khoảng cách để nhặt
local PickupHeight = 0.5                -- Bay cao hơn item một chút

--===== DỊCH VỤ =====--
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")

--===== HUD =====--
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
local label = Instance.new("TextLabel", gui)
label.Size = UDim2.new(0, 260, 0, 50)
label.Position = UDim2.new(0, 10, 0, 10)
label.BackgroundTransparency = 0.4
label.BackgroundColor3 = Color3.new(0,0,0)
label.TextColor3 = Color3.new(1,1,1)
label.TextScaled = true
label.Text = "Balls: 0 | Coins: 0 | Auto: ON"

local autoFarm = true
local ballCount, coinCount = 0, 0
local items = {}
local currentTarget = nil

--===== ANTI AFK =====--
for _,v in pairs(getconnections(player.Idled)) do
    v:Disable()
end

--===== NOCLIP =====--
RunService.Stepped:Connect(function()
    if character and character:FindFirstChild("Humanoid") then
        character.Humanoid:ChangeState(11) -- NoClip
    end
end)

--===== CẬP NHẬT HUD =====--
local function updateHUD()
    label.Text = ("Balls: %d | Coins: %d | Auto: %s"):format(
        ballCount, coinCount, autoFarm and "ON" or "OFF"
    )
end

--===== TÌM ITEM =====--
local function matchName(obj)
    local lowerName = obj.Name:lower()
    for _, key in ipairs(NameKeys) do
        if lowerName:find(key:lower()) then
            return true
        end
    end
    return false
end

local function addItem(obj)
    if obj:IsA("BasePart") and matchName(obj) then
        print("[AutoFarm] Found item:", obj.Name)
        table.insert(items, obj)
        obj.AncestryChanged:Connect(function(_, parent)
            if not parent then
                if obj.Name:lower():find("beachball") then
                    ballCount += 1
                elseif obj.Name:lower():find("coin") then
                    coinCount += 1
                end
                updateHUD()
                for i, v in ipairs(items) do
                    if v == obj then
                        table.remove(items, i)
                        break
                    end
                end
                if currentTarget == obj then
                    currentTarget = nil
                end
            end
        end)
    elseif obj:IsA("BasePart") then
        -- In tên item lạ
        print("[AutoFarm] Unknown item:", obj.Name)
    end
end

for _,v in ipairs(Workspace:GetDescendants()) do
    addItem(v)
end
Workspace.DescendantAdded:Connect(addItem)

--===== LẤY MỤC TIÊU GẦN NHẤT =====--
local function getClosest()
    local closest, dist
    for _, obj in ipairs(items) do
        if obj and obj.Parent then
            local d = (hrp.Position - obj.Position).Magnitude
            if d <= ScanRange then
                if not closest or d < dist then
                    closest, dist = obj, d
                end
            end
        end
    end
    return closest, dist
end

--===== FARM =====--
RunService.Heartbeat:Connect(function(dt)
    if not autoFarm then return end
    if not currentTarget or not currentTarget.Parent then
        currentTarget = getClosest()
    end
    if currentTarget then
        local targetPos = currentTarget.Position + Vector3.new(0, PickupHeight, 0)
        local direction = (targetPos - hrp.Position).Unit
        hrp.Velocity = direction * FlySpeed
        hrp.CFrame = CFrame.new(hrp.Position, targetPos)

        if (hrp.Position - currentTarget.Position).Magnitude <= PickupDist then
            firetouchinterest(hrp, currentTarget, 0)
            firetouchinterest(hrp, currentTarget, 1)
        end
    else
        hrp.Velocity = Vector3.new(0,0,0)
    end
end)

--===== PHÍM TẮT BẬT/TẮT =====--
UIS.InputBegan:Connect(function(input, gpe)
    if not gpe and input.KeyCode == Enum.KeyCode.G then
        autoFarm = not autoFarm
        updateHUD()
    end
end)
